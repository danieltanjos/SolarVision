<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento - SolarVision</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body { background-color: #f8f9fa; }
        .chart-card { min-height: 400px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">SolarVision Monitor</span>
            <a href="../home/home.html" class="btn btn-outline-primary btn-sm">Voltar</a>
        </div>
    </nav>

    <main class="container">
        <h2 class="mb-4 text-secondary">Geração de Energia (5 min)</h2>

        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="card-title">Produção em Tempo Real</h5>
                <p class="card-text text-muted">Visualização da potência gerada (Watts).</p>
                
                <div id="graficoEnergia" class="chart-card">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        async function carregarGrafico() {
            try {
                // 1. Busca os dados da nossa API
                const response = await fetch('/api/leituras');
                const dados = await response.json();

                // Se não tiver dados, avisa
                if (dados.length === 0) {
                    document.getElementById('graficoEnergia').innerHTML = '<p class="text-center mt-5">Nenhum dado encontrado.</p>';
                    return;
                }

                // 2. Configuração do Gráfico (ApexCharts)
                const options = {
                    series: [{
                        name: 'Potência (Watts)',
                        data: dados // A API já devolve no formato {x, y}
                    }],
                    chart: {
                        type: 'area', // Tipo área fica bonito para energia
                        height: 350,
                        zoom: { enabled: false }
                    },
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 2 },
                    xaxis: {
                        type: 'datetime', // Eixo X inteligente para datas
                        labels: { datetimeFormatter: { hour: 'HH:mm' } }
                    },
                    yaxis: {
                        title: { text: 'Watts' }
                    },
                    colors: ['#ffc107'], // Cor amarela (sol)
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.7,
                            opacityTo: 0.9,
                            stops: [0, 90, 100]
                        }
                    }
                };

                // 3. Renderiza o gráfico
                // Limpa o loading
                document.getElementById('graficoEnergia').innerHTML = '';
                const chart = new ApexCharts(document.querySelector("#graficoEnergia"), options);
                chart.render();

            } catch (error) {
                console.error(error);
                document.getElementById('graficoEnergia').innerHTML = '<p class="text-danger text-center">Erro ao carregar gráfico.</p>';
            }
        }

        // Chama a função ao carregar a página
        document.addEventListener('DOMContentLoaded', carregarGrafico);
    </script>

</body>
</html>